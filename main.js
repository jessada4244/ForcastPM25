firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á popup ‡∏à‡∏≤‡∏Å Firebase
async function loadAndShowPopup() {
    try {
        console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5...");
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° timestamp ‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 1 document
        const querySnapshot = await db.collection("pm25_cmucc")
            .orderBy("timestamp", "desc")
            .limit(1)
            .get();
        
        if (!querySnapshot.empty) {
            // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const doc = querySnapshot.docs[0];
            const data = doc.data();
            
            console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:", data);
            
            const pm25Value = parseFloat(data.pm25);
            const timestamp = data.timestamp;
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ PM2.5
            const result = getPMStatus(pm25Value);
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
            const formattedTime = formatThaiDateTime(timestamp);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô update-time
            updateTimeDisplay(formattedTime);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup
            const message = `${result.introducetext}`;
            
            console.log("‡πÅ‡∏™‡∏î‡∏á popup ‡∏Ñ‡πà‡∏≤ PM2.5 ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:", pm25Value);
            showPopup(pm25Value, result.status, result.colorClass, message);
            
        } else {
            console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5");
            updateTimeDisplay("‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö");
            showPopup(0, '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', 'gray', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®');
        }
        
    } catch (error) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5 ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
        updateTimeDisplay("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        showPopup(0, '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'gray', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ PM2.5
function getPMStatus(pmValue) {
    const pmNum = parseFloat(pmValue);
    let status, colorClass, introducetext, backgroundColor;
    
    if (pmNum <= 25) {
        status = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å';
        colorClass = 'blue';
        backgroundColor = '#4FC3F7';
        introducetext = '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß';
    } else if (pmNum <= 50) {
        status = '‡∏î‡∏µ';
        colorClass = 'green';
        backgroundColor = '#66BB6A';
        introducetext = '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥';
    } else if (pmNum <= 100) {
        status = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
        colorClass = 'yellow';
        backgroundColor = '#FFCA28';
        introducetext = '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ ';
    } else if (pmNum <= 200) {
        status = '‡πÑ‡∏°‡πà‡∏î‡∏µ';
        colorClass = 'orange';
        backgroundColor = '#ff8c00';
        introducetext = '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á';
    } else {
        status = '‡πÅ‡∏¢‡πà‡∏°‡∏≤‡∏Å';
        colorClass = 'red';
        backgroundColor = '#EF5350';
        introducetext = '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏Ñ‡∏ß‡∏£‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ';
    }
    
    return { status, colorClass, introducetext, backgroundColor };
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
function updateTimeDisplay(formattedTime) {
    const updateTimeElement = document.getElementById('update-time');
    if (updateTimeElement) {
        updateTimeElement.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${formattedTime}`;
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å)
async function loadData() {
    const container = document.getElementById('dataContainer');
    
    try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 document ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° timestamp ‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        const querySnapshot = await db.collection("pm25_cmucc")
            .orderBy("timestamp", "desc")
            .limit(1)
            .get();
        
        if (querySnapshot.empty) {
            container.innerHTML = '<div class="loading">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            return;
        }

        // ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏µ‡∏¢‡∏á document ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        const doc = querySnapshot.docs[0];
        const data = doc.data();
        
        console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:", data);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pm25 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (data.pm25 !== undefined) {
            const html = `
                <div class="data-grid">
                    ${createPMCardHTML(doc.id, data.pm25, data.pm24, data.pm48, data.pm72, data.timestamp)}
                </div>
            `;
            container.innerHTML = html;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô update-time
            if (data.timestamp) {
                const formattedTime = formatThaiDateTime(data.timestamp);
                updateTimeDisplay(formattedTime);
            }
        } else {
            container.innerHTML = '<div class="loading">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5</div>';
        }
        
    } catch (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error);
        
        // ‡∏ñ‡πâ‡∏≤ error ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á index ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        if (error.code === 'failed-precondition' || error.message.includes('index')) {
            container.innerHTML = `
                <div class="error">
                    <strong>‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firestore:</strong><br>
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase Console > Firestore Database > Indexes<br>
                    ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á composite index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö collection: pm25_cmucc<br>
                    Field: timestamp (Descending)<br><br>
                    ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: <code>firebase firestore:indexes</code><br><br>
                    <small>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${error.message}</small>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="error">
                    <strong>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong><br>
                    ${error.message}<br><br>
                    <small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Configuration ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</small>
                </div>
            `;
        }
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á timestamp ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
function formatThaiDateTime(timestamp) {
    const thaiMonths = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
        '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
        '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ];
    
    let date;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ timestamp ‡πÄ‡∏õ‡πá‡∏ô Firebase Timestamp ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (timestamp && timestamp.toDate) {
        date = timestamp.toDate();
    } 
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Date object
    else if (timestamp instanceof Date) {
        date = timestamp;
    } 
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Unix timestamp)
    else if (typeof timestamp === 'number') {
        date = new Date(timestamp);
    }
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô string ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Date ‡πÑ‡∏î‡πâ
    else if (typeof timestamp === 'string') {
        date = new Date(timestamp);
    }
    else {
        return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ date ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (isNaN(date.getTime())) {
        return '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    }
    
    const day = date.getDate();
    const month = thaiMonths[date.getMonth()];
    const year = date.getFullYear() + 543;
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');

    return `${day} ${month} ${year} ‡πÄ‡∏ß‡∏•‡∏≤ ${hours}:${minutes} ‡∏ô.`;
}
// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
function showCurrentTime() {
    const now = new Date();

    const thaiMonths = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
        '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
        '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ];

    const day = now.getDate();
    const month = thaiMonths[now.getMonth()];
    const year = now.getFullYear() + 543;
    

    const formatted = `${day} ${month} ${year} `;

    const currentTimeElement = document.getElementById("current-time");
    if (currentTimeElement) {
        currentTimeElement.textContent = formatted;
    }
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(showCurrentTime, 1000);
showCurrentTime();


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á popup 
function showPopup(pm25Value, status, colorClass, message) {
    const modalOverlay = document.getElementById('modalOverlay');
    const modal = document.getElementById('modal');
    const popupCircle = document.getElementById('popupCircle');
    const popupTitle = document.getElementById('popupTitle');

    const popupMessage = document.getElementById('popupMessage');

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÉ‡∏ô popup
    popupCircle.className = `circlepopup ${colorClass}`;
    popupCircle.innerHTML = `
        <div>PM 2.5</div>
        <div style="font-size: 2em; font-weight: bold;">${pm25Value}</div>
        <div>${status}</div>
    `;

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    popupTitle.textContent = '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' ;
    
    popupMessage.innerHTML = message;

    // ‡πÅ‡∏™‡∏î‡∏á modal
    modalOverlay.classList.add('show');
    modal.classList.remove('closing');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î popup
function closePopup() {
    const modalOverlay = document.getElementById('modalOverlay');
    const modal = document.getElementById('modal');
    
    modal.classList.add('closing');
    setTimeout(() => {
        modalOverlay.classList.remove('show');
        modal.classList.remove('closing');
    }, 300);
}

// ‡∏õ‡∏¥‡∏î popup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
document.getElementById('modalOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closePopup();
    }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ PM (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô)
function createPMCardHTML(docId, pmValue, pm24, pm48, pm72, timestamp) {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
    const currentPM = getPMStatus(pmValue);
    const pm24Status = getPMStatus(pm24);
    const pm48Status = getPMStatus(pm48);
    const pm72Status = getPMStatus(pm72);

    
    return `
    <div class="air-container">

  <!-- ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÉ‡∏´‡∏ç‡πà) -->
  <div class="air-today">
        <div>
         <h3>‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ </h3>
         <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="current-time"></span></div>
        <div  class="circle-today" style="background-color: ${currentPM.backgroundColor} ;" onclick="showDetailPopup('${pmValue}', '${currentPM.status}')">
            <div>PM 2.5</div>
            <div class="pm-value" style="color: black; font-weight: bold; font-size: 2em;">${pmValue}</div>
            <div>${currentPM.status}</div>
        </div>
        </div>
        <!-- ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢) -->
  <div class="air-hours">
        <div>
         <p>24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
        <div class="circle" style="background-color: ${pm24Status.backgroundColor};" onclick="showDetailPopup('${pm24}', '${pm24Status.status}')">
            <div>PM 2.5</div>
            <div class="pm-value" style="color: black; font-weight: bold; font-size: 2em;">${pm24}</div>
            <div>${pm24Status.status}</div>
        </div>
         </div>
        <div>
         <p>48 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
        <div class="circle" style="background-color: ${pm48Status.backgroundColor};" onclick="showDetailPopup('${pm48}', '${pm48Status.status}')">
            <div>PM 2.5</div>
            <div class="pm-value" style="color: black; font-weight: bold; font-size: 2em;">${pm48}</div>
            <div>${pm48Status.status}</div>
        </div>
         </div>
        <div>
         <p>72 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
        <div class="circle" style="background-color: ${pm72Status.backgroundColor};" onclick="showDetailPopup('${pm72}', '${pm72Status.status}')">
            <div>PM 2.5</div>
            <div class="pm-value" style="color: black; font-weight: bold; font-size: 2em;">${pm72}</div>
            <div>${pm72Status.status}</div>
        </div>
        </div>
    `;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á popup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏°
function showDetailPopup(pmValue, status) {
    const result = getPMStatus(pmValue);
    showPopup(pmValue, status, result.colorClass, result.introducetext);
}

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
window.onload = function() {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
    loadData();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Firebase ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (typeof firebase !== 'undefined' && firebase.firestore) {
        // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
        setTimeout(() => {
            loadAndShowPopup();
        }, 1000); // ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à
    } else {
        console.warn("Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
        // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        setTimeout(() => {
            const testTimestamp = new Date();
            const formattedTime = formatThaiDateTime(testTimestamp);
            updateTimeDisplay(formattedTime);
            const message = `‡∏Ñ‡πà‡∏≤ PM 2.5 ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 201 Œºg/m¬≥<br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÅ‡∏¢‡πà‡∏°‡∏≤‡∏Å<br><br>üìÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${formattedTime}`;
            showPopup(201, '‡πÅ‡∏¢‡πà‡∏°‡∏≤‡∏Å', 'red', message);
        }, 1500);
    }
};
